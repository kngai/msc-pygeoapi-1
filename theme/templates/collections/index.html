{% extends "_base.html" %}
{% block title %}{{ super() }} Collections {% endblock %}
{% block crumbs %}{{ super() }}
<li><a href="./collections">Collections</a></li>
{% endblock %}
{% block body %}
    <section id="collections">
      <h1>Collections in this service</h1>
      <table class="table table-striped">
        <thead>
        <tr>
          <th v-for="(th, index) in tableFields"
            :class="[th.colClass]"
            @click="sortDir(th.key)">[% th.text %]
            <span
              v-show="currentSort === th.key"
              :class="sortIconClass"
              class="glyphicon"></span>
          </th>
        </tr>
        </thead>
        <tbody>
          <tr v-for="(collection, index) in filteredCollections">
            <td data-label="name">
              <a :title="truncateAndStripTags(collection.title)"
                :href="'{{ config['server']['url'] }}/collections/' + collection.id">
                <span>[% truncateAndStripTags(collection.title) %]</span></a>
            </td>
            <td data-label="type">[% collection.itemType %]</td>
            <td data-label="description">
              [% collection.description %]
            </td>
          </tr>
        </tbody>
      </table>
    </section>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.21.1/axios.min.js"></script>
    <script type="module">
      import { createApp, ref, computed, onMounted } from 'https://cdnjs.cloudflare.com/ajax/libs/vue/3.0.5/vue.esm-browser.prod.js'

      const app = createApp({
        delimiters: ['[%', '%]'],
        setup() {
          // table configs
          const tableFields = ref([
            {
              key: 'title',
              text: 'Name',
              colClass: 'col-sm-3'
            }, {
              key: 'itemType',
              text: 'Type',
              colClass: 'col-sm-1'
            }, {
              key: 'description',
              text: 'Description',
              colClass: 'col-sm-7'
            }
          ])

          // table sorting
          const currentSortDir = ref('asc')
          const currentSort = ref('title') // default to first column
          const sortDir = function (s) {
            // if s == current sort, reverse
            if (s === currentSort.value) {
              currentSortDir.value = currentSortDir.value === 'asc' ? 'desc' : 'asc'
            }
            currentSort.value = s
          }
          const sortIconClass = computed(() => {
            if (currentSortDir.value === 'asc') {
              return 'glyphicon-sort-by-attributes'
            } else {
              return 'glyphicon-sort-by-attributes-alt'
            }
          })

          // htmlString modications in table
          const stripTags = function (htmlString) {
            return htmlString.replace(/<[^>]+>/g, '')
          }
          const truncate = function (str, num) {
            if (str.length <= num) {
              return str
            }
            return str.slice(0, num) + '...'
          }
          const truncateAndStripTags = function (str) {
            return truncate(stripTags(str), 50)
          }

          // get collections XHR handling
          let collections = ref([])
          let filteredCollections = computed(() => {
            const compare = function (a, b) { // sort function
              let modifier = 1
              if (currentSortDir.value === 'desc') {
                modifier = -1
              }
              if (a[currentSort.value] < b[currentSort.value]) {
                return -1 * modifier
              }
              if (a[currentSort.value] > b[currentSort.value]) {
                return 1 * modifier
              }
              return 0
            }

            return collections.value.sort(compare)
          })
          const getCollections = async () => {
            try {
              const resp = await axios.get('/collections?f=json')
              collections.value = resp.data.collections
            } catch (err) {
              console.error(err)
            }
          }
          onMounted(getCollections())

          return {
            tableFields, collections, truncateAndStripTags, filteredCollections, sortIconClass, sortDir, currentSort, currentSortDir
          }
        }
      }).mount('#collections')
      
    </script>
{% endblock %}
